<html>
  <head>
    <link rel="stylesheet" type="text/css" href="main.css">
  </head>
  <body>

      <div id="GUI">
  </div>
    <div id="hookInfo">
      <div id="hookCount"> HELLO </div>

    </div>

    <div id = "curious">

      <p> Well. You made it. </p>
      <p> Thanks for playing, and being curious! </p>
      <p> If you enjoyed playing, say hi on twitter: @cabbibo.</p>
      <p> A huge thanks goes out to the following,</p>
      <p> who helped make this project happen ( for free! ): </p>
      <p> @L4Suicide ( Audio ) </p>
      <p> @SteveTeeps ( Models ) </p>
      <p> @TheSpite ( Shader Help ) </p>
      <p> @mrdoob ( three.js ) </p>

    </div>

<script src = "lib/jquery.min.js"         ></script>
<script src = "lib/Tween.js"              ></script>
<script src = "lib/leap.js"               ></script>
<script src = "lib/three.js"              ></script>
<script src = "lib/stats.min.js"          ></script>
<script src = "lib/TrackballControls.js"  ></script>
<script src = "lib/FlyControls.js"        ></script>
<script src = "lib/OBJLoader.js"          ></script>
<script src = "lib/TextCreator.js"        ></script>
<script src = "lib/AudioController.js"    ></script>
<script src = "lib/Looper.js"             ></script>
<script src = "lib/AudioTexture.js"       ></script>
<script src = "lib/UserAudio.js"          ></script>
<script src = "lib/Stream.js"             ></script>
<script src = "lib/underscore.js"         ></script>
<script src = "lib/ShaderLoader.js"       ></script>
<script src = "lib/Loader.js"             ></script>
<script src = "lib/PhysicsRenderer.js"    ></script>
<script src = "lib/ParticleUtils.js"      ></script>
<script src = "lib/LoadedAudio.js"        ></script>
<script src = "lib/dat.gui.min.js"        ></script>

<script src = "lib/TextParticles.js"      ></script>
<script src = "lib/PhysicsText.js"        ></script>

<script src = "init/initExplosion.js"     ></script>
<script src = "init/initHooks.js"         ></script>
<script src = "init/initAudio.js"         ></script>
<script src = "init/initThree.js"         ></script>
<script src = "init/initDebug.js"         ></script>
<script src = "init/initGeos.js"          ></script>
<script src = "init/initMaterials.js"     ></script>
<script src = "init/initRepelers.js"      ></script>
<script src = "init/initGems.js"          ></script>
<script src = "init/initStones.js"        ></script>
<script src = "init/initEasterEgg.js"     ></script>

<script src = "levels/Level1.js"          ></script>
<script src = "levels/Level2.js"          ></script>
<script src = "levels/Level3.js"          ></script>
<script src = "levels/Level4.js"          ></script>
<script src = "levels/Level5.js"          ></script>
<script src = "levels/Level6.js"          ></script>
<script src = "levels/Level7.js"          ></script>
<script src = "levels/Level8.js"          ></script>
<script src = "levels/Credits.js"         ></script>

<script src = "js/Level.js"               ></script>
<script src = "js/Fish.js"                ></script>
<script src = "js/fishSkeleton.js"        ></script>
<script src = "js/DragonFish.js"          ></script>
<script src = "js/Hook.js"                ></script>

<script src = "js/mechanics.js"           ></script>
<script src = "js/utils.js"               ></script>

<script src = "js/FurryGroup.js"        ></script>
<script src = "js/FurryTail.js"        ></script>
<script src = "js/FurryHead.js"        ></script>

<script src = "js/instructions.js"        ></script>
<script src = "js/addSocialMedia.js"      ></script>

<script src = "js/GEM.js"                      ></script>
<script src = "js/GUI.js"                      ></script>
<script src = "js/CurlMesh.js"                 ></script>
<script src = "js/RepelerMesh.js"              ></script>

<script>  

  var container , camera, scene, renderer , stats;
  var clock;

  
  var TMP_VECTOR_3    = new THREE.Vector3();
  var TMP_VECTOR_3_2  = new THREE.Vector3();

  var levelDebug = false;
 // levelDebug = true;

  var tv = TMP_VECTOR_3;
  var tv1 = TMP_VECTOR_3_2;

  // color that defines everything
  var baseColor;
  var sceneSize = 10;
  var fish;
  var fishes = [];
  var tmpMat;
  var jellyMat;
  var lights = [];
  var mouse =  new THREE.Vector2();
  var counter = 0;
  var time = { type:"f" , value:0 }
  var timer = time;
  var dT = { type:"f" , value:0 }
  var dpr = { type:"f" , value: window.devicePixelRatio || 1 }
  var t_audio = { type:"t" , value:null }
  var lightColors = { type:"v3v" , value:[] }; 
  var lightDirections = { type:"v3v" , value:[] }; 
  var intersectPlane;
  var projector , raycaster;
  var paused = false;
  var distanceToIntersectPlane = 15;
  var SCORE = 0;
  var CURRENT_LEVEL = 0;
  var LEVELS = [];
  var REPELERS = [];

  for( var i  =0; i < 6; i++ ){

    lightColors.value.push( new THREE.Vector3() );
    lightDirections.value.push( new THREE.Vector3() );

  }
  var startingCrystal;

  var textCreator = new TextCreator( 100 );
  var textParticles;// = new TextParticles(); 


  var loader = new Loader({ numberToLoad: 0 });

  //loader.beginLoading();
  var shaders = new ShaderLoader('shaders');
  shaders.beginLoad = function(){
    loader.beginLoading();
  }

  shaders.endLoad = function(){
    loader.endLoading();
  }

  shaders.shaderSetLoaded = function(){
    //init();

  }

  shaders.load( 'vs-planet' , 'planet' , 'vertex' );
  shaders.load( 'vs-planetDisplace' , 'planetDisplace' , 'vertex' );
  shaders.load( 'fs-planet' , 'planet' , 'fragment' );
  shaders.load( 'fs-floor'    , 'floor'   , 'fragment'    );
  shaders.load( 'vs-floor'    , 'floor'   , 'vertex'      );
  shaders.load( 'fs-sphere'   , 'sphere'  , 'fragment'    );
  shaders.load( 'vs-sphere'   , 'sphere'  , 'vertex'      );

  shaders.load( 'fs-simPos'   , 'posSim'  , 'simulation'  );
  shaders.load( 'fs-simVel'   , 'velSim'  , 'simulation'  );

  shaders.load( 'fs-clueLine'   , 'clueLine'  , 'fragment'    );
  shaders.load( 'vs-clueLine'   , 'clueLine'  , 'vertex'      );
  
  shaders.load( 'fs-audioDisplace'   , 'audioDisplace'  , 'fragment'    );
  shaders.load( 'vs-audioDisplace'   , 'audioDisplace'  , 'vertex'      );
  
  shaders.load( 'fs-shineDisplace'   , 'shineDisplace'  , 'fragment'    );
  shaders.load( 'vs-shineDisplace'   , 'shineDisplace'  , 'vertex'      );
  
  shaders.load( 'fs-audioSEM'   , 'audioSEM'  , 'fragment'    );
  shaders.load( 'vs-audioSEM'   , 'audioSEM'  , 'vertex'      );
  
  shaders.load( 'fs-audioBright'   , 'audioBright'  , 'fragment'    );
  shaders.load( 'vs-audioBright'   , 'audioBright'  , 'vertex'      );
  
  shaders.load( 'fs-audioGem'   , 'audioGem'  , 'fragment'    );
  shaders.load( 'vs-audioGem'   , 'audioGem'  , 'vertex'      );
  
  shaders.load( 'fs-audioLambert'   , 'audioLambert'  , 'fragment'    );
  shaders.load( 'vs-audioLambert'   , 'audioLambert'  , 'vertex'      );
  
  shaders.load( 'fs-edge'   , 'edge'  , 'fragment'    );
  shaders.load( 'vs-edge'   , 'edge'  , 'vertex'      );
  
  shaders.load( 'fs-easter'   , 'easter'  , 'fragment'    );
  shaders.load( 'vs-easter'   , 'easter'  , 'vertex'      );
  
  shaders.load( 'fs-render'   , 'render'  , 'fragment'    );
  shaders.load( 'vs-render'   , 'render'  , 'vertex'      );
  shaders.load( 'curlSim'   , 'curlSim' , 'simulation'  );
  
  shaders.load( 'fs-deathParticles'   , 'deathParticles'  , 'fragment'    );
  shaders.load( 'vs-deathParticles'   , 'deathParticles'  , 'vertex'      );
  shaders.load( 'deathSim'            , 'deathSim'        , 'simulation'  );
  
  
  shaders.load( 'ss-text'   , 'text' , 'simulation'  );
  shaders.load( 'fs-text'   , 'text' , 'fragment'  );
  shaders.load( 'vs-text'   , 'text' , 'vertex'  );
  
  shaders.load( 'ss-furryTail'   , 'furryTail' , 'simulation'  );
  shaders.load( 'fs-furryTail'   , 'furryTail' , 'fragment'  );
  shaders.load( 'vs-furryTail'   , 'furryTail' , 'vertex'  );

  shaders.load( 'ss-furryHead'   , 'furryHead' , 'simulation'  );
  shaders.load( 'fs-furryHead'   , 'furryHead' , 'fragment'  );
  shaders.load( 'vs-furryHead'   , 'furryHead' , 'vertex'  );

  shaders.load( 'fs-furryParticles'   , 'furryParticles' , 'fragment'  );
  shaders.load( 'vs-furryParticles'   , 'furryParticles' , 'vertex'  );

    
  shaders.load( 'ss-curlMesh'       , 'curlMesh'  , 'simulation'  );
  shaders.load( 'ss-repelerMesh'    , 'repelerMesh'  , 'simulation'  );
  shaders.load( 'vs-curl1'          , 'curl1'     , 'vertex'      );
  shaders.load( 'fs-curl1'          , 'curl1'     , 'fragment'    );



  var audioController = new AudioController();

 // audioController.mute.gain.value = 0;

  t_audio.value = audioController.texture;

  var looper          = new Looper( audioController , time , {

    beatsPerMinute: 122,
    beatsPerMeasure: 4,
    measuresPerLoop: 8
    
  });
  var particleTexture = THREE.ImageUtils.loadTexture( 'lib/flare.png');


  var LEVEL_1,LEVEL_2,LEVEL_3 ,LEVEL_4,LEVEL_5,LEVEL_6,LEVEL_7,LEVEL_8;

  function onStart(){

    addInstructions();

  }
  
  loader.beginLoading();
  initGeos();
  loader.endLoading();

    bait = new THREE.Object3D();


  function init(){

    textParticles = new TextParticles({
      vertexShader: shaders.vertexShaders.text, 
      fragmentShader: shaders.fragmentShaders.text, 
    }); 

    initThree();
    initAudio();
    initMechanics();
    initDebug();
    initMaterials();
    initRepelers();
    initGems();
    initStones();
    initEasterEgg();



    // Object our dragon fish follows
    dragonFish = new DragonFish( bait );
    dragonFish.leader.position.copy( camera.position );

    startingCrystal = new THREE.Mesh( GEOS['icosa'] , MATS['basic'] );

    //dragonFish.leader.add( startingCrystal );

    // THE DEATH FOLLOWER
    deathBait = new THREE.Object3D();
    deathBait.oldPositions = [];
    deathBait.velocity = new THREE.Vector3();
    deathDragon = new DragonFish( deathBait );
    deathDragon.createVertabrae( deathDragon.leader );

    var m = new THREE.Mesh( GEOS['cube'] , MATS['normal'] );

    deathDragon.initPlume(m);

    deathDragon.bait.position.copy( new THREE.Vector3( 100000, 0 , 0 ) );
    deathDragon.leader.position.copy( new THREE.Vector3( 100000, 0 , 0 ) );

    //HACK
    deathDragon.recursiveCall( deathDragon.plumeBabies[0] , function( obj ){
      obj.position.copy( deathDragon.bait.position );
    });

    deathDragon.recursiveCall( deathDragon.plumeBabies[1] , function( obj ){
      obj.position.copy( deathDragon.bait.position );
    });
    

    deathDragon.recursiveCall( deathDragon.plumeBabies[2] , function( obj ){
      obj.position.copy( deathDragon.bait.position );
    });

  
      deathDragon.attacking = false;
    deathDragon.attack = function(){

      this.attacking = true;

    }

    deathDragon.retreat = function(){

      this.attacking = false;

    }

    deathDragon.reset = function(){

     // this.leader.position.add( new THREE.Vector3( 50000 , 0 , 0 ) );


    }
    //deathDragon.attack();


    loader.addToLoadBar();
    
    LEVEL_1 = new Level( 'first level'  , dragonFish , LEVEL_1_PARAMS );
    LEVEL_2 = new Level( 'second level' , dragonFish , LEVEL_2_PARAMS );
    LEVEL_3 = new Level( 'third level'  , dragonFish , LEVEL_3_PARAMS );
    LEVEL_4 = new Level( 'fourth level' , dragonFish , LEVEL_4_PARAMS );
    LEVEL_5 = new Level( 'fifth level'  , dragonFish , LEVEL_5_PARAMS );
    LEVEL_6 = new Level( 'sixth level'  , dragonFish , LEVEL_6_PARAMS );
    LEVEL_7 = new Level( 'sixth level'  , dragonFish , LEVEL_7_PARAMS );
    LEVEL_8 = new Level( 'sixth level'  , dragonFish , LEVEL_8_PARAMS );
    CREDITS = new Level( 'Credit level' , dragonFish , CREDITS_PARAMS );

    
    LEVEL_1.nextLevel = LEVEL_2;
    LEVEL_2.oldLevel  = LEVEL_1;

    LEVEL_2.nextLevel = LEVEL_3;
    LEVEL_3.oldLevel  = LEVEL_2;

    LEVEL_3.nextLevel = LEVEL_4;
    LEVEL_4.oldLevel  = LEVEL_3;

    LEVEL_4.nextLevel = LEVEL_5;
    LEVEL_5.oldLevel  = LEVEL_4;

    LEVEL_5.nextLevel = LEVEL_6;
    LEVEL_6.oldLevel  = LEVEL_5;
    
    LEVEL_6.nextLevel = LEVEL_7;
    LEVEL_7.oldLevel  = LEVEL_6;

    LEVEL_7.nextLevel = LEVEL_8;
    LEVEL_8.oldLevel  = LEVEL_7;


    LEVEL_8.nextLevel = CREDITS;
    CREDITS.oldLevel  = LEVEL_8;
    
    LEVELS.push( LEVEL_1 );
    LEVELS.push( LEVEL_2 );
    LEVELS.push( LEVEL_3 );
    LEVELS.push( LEVEL_4 );
    LEVELS.push( LEVEL_5 );
    LEVELS.push( LEVEL_6 );
    LEVELS.push( LEVEL_7 );
    LEVELS.push( LEVEL_8 );
    LEVELS.push( CREDITS );



    var loc = window.location.hash.substring(1);
    CURRENT_LEVEL = loc || 0;
    var firstLevel = LEVELS[ CURRENT_LEVEL ];

    firstLevel.beginLoading();
    firstLevel.onPrepared = function(){
      loader.endLoading();
    }
    firstLevel.oldLevel = null;

    camera.position.copy( firstLevel.scene.position );
    camera.position.z += 50;
    camera.lookAt( firstLevel.scene.position );


    // Hooks
    recreateLights( 0x777777 , .1 );
    
    addSocialMedia( SOCIAL_MEDIA );
    

  }

  function animate(){

    TWEEN.update();

    counter += 1;


    EasterEgg.checkForAdd();

    updateInstructions();

    LEVELS[ CURRENT_LEVEL ].update();

    audioController.update();
     
    var delta = clock.getDelta();

    // updates the dragonFish
    updateMechanics( delta );

    dT.value = delta;
    time.value += delta;
    stats.update();

    
    if( !paused ){
      
      dragonFish.update();
      deathDragon.update();

      tv.copy( dragonFish.leader.position );
      tv.sub( deathDragon.leader.position );

      var length = tv.length();
     
      if( deathDragon.attacking === true ){

        if( tv.length() <= 3 ){

          LEVELS[ CURRENT_LEVEL ].onDeath();//deathNote.play();
          deathDragon.reset();

        }

      }

      var newGain = Math.min( 10. , 1000 / ( length * length ));
      LEVELS[ CURRENT_LEVEL ].death.loop.gain.gain.value = newGain


    }
    
    for( var i = 0; i < REPELERS.length; i++ ){        
      var ind = i / (2 * REPELERS.length); 
      var fI = Math.floor( ind * audioController.analyzer.array.length );
      var p = audioController.analyzer.array[ fI ];
      //console.log( p );
      REPELERS[i].power.x = p / 128;
    }

    // Updates our explosion particles
    //explosion.renderer.update();
    soulSucker.renderer.update();
    
    renderer.render( scene , camera );
    requestAnimationFrame( animate );

    // Reseting values if we just got hit
    explosion.renderer.simulationUniforms.justHit.value = 0.;

  }

  $("#startInfo").click( function(){

    loader.liftCurtain();

    initExplosion( dragonFish );
    initSoulSucker( dragonFish , deathDragon );
    LEVELS[ CURRENT_LEVEL ].initialize();

    looper.start();
    animate();

    onStart();
  
  });


  $('.social').hover( function( e ){
    console.log( 'mouseasdasd');
    if( e.type == 'mouseenter' ){
      console.log('asfasfdddssddssd');
      titleEP.innerHTML = e.toElement.INFO_TEXT;
    }else{
      titleEP.innerHTML = 'DRAGONFISH';
    }
  });

  $("#information").click( function(){
    $("#informationSection").toggle();
  });

</script>


</body>
</html>


